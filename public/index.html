<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Walmart âœ³ â€” VoxTalkâ„¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="navbar">
    <div class="brand-bar">
      <h1 class="brand">
        <span class="brand-main">Walmart</span>
        <span class="brand-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="spark">
            <path fill="#fdb913" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(60 32 32)" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(120 32 32)" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(180 32 32)" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(240 32 32)" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(300 32 32)" d="M31 0h2v22h-2z"/>
          </svg>
        </span>
      </h1>
    </div>
    
    <div class="ai-integration-bar">
        <button id="haloBtn" class="voxtalk-tab">
            <span class="status-dot"></span>
            <span id="haloLabel">Try our Walmart AI Assistant â€” New</span>
        </button>
        <button id="taglineUpload" class="upload-btn">Upload your grocery list here</button>
    </div>
  </header>

  <main class="container">
    <div class="portal-row">
      <button class="portal" onclick="openModal('cartModal')">ğŸ›’ Cart</button>
      <button class="portal" onclick="openModal('infoModal')">â„¹ï¸ Info</button>
      <button class="portal" onclick="window.open('https://www.walmart.com/grocery','_blank')">ğŸ’³ Checkout</button>
    </div>

    <div class="stage">
      <audio id="remote" autoplay playsinline></audio>
      <button id="stopBtn" class="stop-btn hidden">Pause Voice</button>
    </div>

    <section class="quiet">
      <form id="quietForm" class="quiet-form">
        <input id="quietInput" class="quiet-input" type="text" placeholder="Type here for quiet environments..." />
        <button id="micBtn" class="pill mic-btn" type="button">ğŸ¤</button>
        <button id="sendBtn" class="pill send-btn" type="submit">Send</button>
      </form>
      <div id="thread" class="thread"></div>
    </section>
  </main>

  <script>
    const haloBtn = document.getElementById("haloBtn");
    const stopBtn = document.getElementById("stopBtn");
    const haloLabel = document.getElementById("haloLabel");
    const remote = document.getElementById("remote");
    let pc, localStream;

    haloBtn.onclick = async () => {
      haloBtn.disabled = true;
      haloLabel.textContent = "Connecting to VoxTalk...";
      try {
        const resp = await fetch("/session", { method: "POST" });
        const data = await resp.json();
        pc = new RTCPeerConnection();
        pc.ontrack = e => remote.srcObject = e.streams[0];
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        const r2 = await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview", {
          method: "POST",
          headers: { Authorization: `Bearer ${data.client_secret.value}`, "Content-Type": "application/sdp" },
          body: offer.sdp
        });
        const answer = { type: "answer", sdp: await r2.text() };
        await pc.setRemoteDescription(answer);
        haloLabel.textContent = "VoxTalk Live: Ask me anything";
        stopBtn.classList.remove("hidden");
      } catch (e) {
        haloLabel.textContent = "Connection Error";
        haloBtn.disabled = false;
      }
    };

    stopBtn.onclick = () => {
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      if (pc) pc.close();
      haloBtn.disabled = false;
      haloLabel.textContent = "Try our Walmart AI Assistant â€” New";
      stopBtn.classList.add("hidden");
    };
  </script>
</body>
</html>
